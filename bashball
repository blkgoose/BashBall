#!/bin/bash
set -e

files="${@}"

tmpdir="/tmp/bashball-$$"
filedir="$tmpdir/files"
mkdir -p "$tmpdir"
mkdir -p "$filedir"
trap 'rm -rf $tmpdir' EXIT

cp "ball.template" "$tmpdir/ball"

hash=$(echo "§bashball_import§" | md5sum | cut -c1-32)

# import functionality
for file in $files
do
	[[ "$file" == "main.sh" ]] &&
		cp "$file" "$filedir" ||
		sed "s/\s*function /function $hash/g" "$file" > "$filedir/$file"
done

cd $filedir
tar -czf - $files | base64 -w0 > "$tmpdir/tar"

printf '%s\n' "/^__TAR/r $tmpdir/tar" w | ed "$tmpdir/ball" 1>/dev/null 2>&1

cat "$tmpdir/ball" |\
tr '\n' '\r' |\
sed -e 's/\r__TAR\r//' -e 's/=\r/=/' |\
tr '\r' '\n' |\
sed -e '/^\s*#[^!].*/d' -e 's/\s*#[^!].*//g' -e '/^\s*$/d' |\
tr '\n' ';' |\
sed 's/{;/{/g' |\
sed 's/;/\n/'
