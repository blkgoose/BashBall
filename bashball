#!/bin/bash
set -e

files="${@}"

tmpdir="/tmp/bashball-$$"
mkdir -p "$tmpdir"
trap 'rm -rf $tmpdir' EXIT

cat > "$tmpdir/ball" <<'EOF'
#!/bin/bash

# check if apps are installed
set -e
declare -a apps=(tar base64)
for app in $apps; do hash $app 2>/dev/null || echo "$app is not installed on this system"; done

# useful variables (can be used in scripts)
export _localdir="$(pwd)"
export _tmpdir="/tmp/bashball-$$"

# makes source function local
source() {
	lib="$1"
	[[ "$lib" =~ \.sh$ ]] || lib="$lib.sh"

	cd "$_tmpdir"
	. "$lib"
}
export -f source

# trap exit and delete temporary folder
trap "rm -rf $_tmpdir" EXIT

# makes temporary folder
mkdir -p $_tmpdir

# __TAR will be replaced with the base64 tarball content
# this extracts the content of the tarball and puts it in the temporary folder
printf $'
__TAR
' | base64 -d | tar xz -C $_tmpdir --warning=no-timestamp

# executes main
bash $_tmpdir/main.sh ${@}
EOF

tar -czf - $files | base64 -w0 > "$tmpdir/tar"

printf '%s\n' "/^__TAR/r $tmpdir/tar" w | ed "$tmpdir/ball" 1>/dev/null 2>&1

cat "$tmpdir/ball" |\
tr '\n' '\r' |\
sed -e 's/\r__TAR\r//' -e 's/=\r/=/' -e "s/\r'/\'/g" |\
tr '\r' '\n' |\
sed -e '/^\s*#[^!].*/d' -e 's/\s*#[^!].*//g' -e '/^\s*$/d' |\
tr '\n' ';' |\
sed 's/{;/{/g' |\
sed 's/;/\n/'
